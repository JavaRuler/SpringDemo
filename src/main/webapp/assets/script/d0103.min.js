'use strict';
$(function() {

	$("#ipAddress").get(0).focus();
    // ================================ 变量声明 ================================ //
    // ContextPath
    var sContextPath = _.CONTEXT_PATH;
    
    var nId = function() {
        if (location.pathname !== _.resolvePath(sContextPath, 'device')){
            var aslocatoin = location.pathname.split("/");
            // 获取 id
            return aslocatoin[aslocatoin.length - 2];
        }
    }();
    var kId = function() {
        if (location.pathname !== _.resolvePath(sContextPath, 'device')){
            var aslocatoin = location.pathname.split("/");
            // 获取 id
            return aslocatoin[aslocatoin.length - 1];
        }
    }();

    var ex = /^\d+$/;
	if (!ex.test(nId)) {
	   nId = kId;
	   kId = null;
	}
	if (!ex.test(kId)) {
	   kId = null
	}
	
    // ================================ 方法声明 ================================ //
    // JS插件渲染及画面初期事件绑定
    function initializePage() {
    	
        // VALIDATION 验证
        var oValidationOption = _.VALIDATION_OPTIONS;
        oValidationOption.rules = {
        	ipAddress: {
                required: true,
                ipv4: true
            },
        	connectPort: {
                required: true,
                number: true,
                fixedlength: 5
            },
        	kbsNo: {
                required: true,
                number: true
            },
            startDate: {
            	required: true
            },
            endDate: {
            	required: true
            }

            
        };	

        $('#devForm').validate(oValidationOption);        
        
        //新增 编辑 
        $('#saveBtn').click(function() {
            // 验证失败,则返回
            if (!$('#devForm').valid()) {
                return false;
            }

            // 提交至后台,根据url进行区分
            var sUrl = _.resolvePath(sContextPath, 'api/device');
            var fMethod = $.post;
            if (kId != null) {
                sUrl = _.resolvePath(sContextPath, 'api/device');
                fMethod = $.put;
            }
            fMethod(sUrl, $('#devForm').serializeJSON()).done(function() {
                back();
            });
        })
        
        
        // datePicker
        $(".input-group.date").datepicker(_.DATEPICKER_OPTIONS);
        
        
        $('#backBtn').click(function() {
            back();
        });
    }

    // 跳回一览画面
    function back(){
        _.route(_.resolvePath(sContextPath, 'devices', nId));
    }

    // 画面初期数据取得
    function getPageData() {
    	if(nId != null && kId != null){
    		var sUrl = _.resolvePath(sContextPath, 'api/device', nId, kId);
            $.get(sUrl).done(function(oData) {
            	$('#kbsSeqNo').val(oData.kbsSeqNo);
            	$('#tenpoSeqNo').val(oData.tenpoSeqNo);
            	$('#tenpoNo').val(oData.tenpoNo);
                $('#tenpoName').val(oData.tenpoName);
            	$('#ipAddress').val(oData.ipAddress);
            	$('#connectPort').val(oData.connectPort);
                $('#kbsNo').val(oData.kbsNo);
            	$('#secchiName').val(oData.secchiName);
            	$('#startDate').val(oData.startDate);
                $('#endDate').val(oData.endDate);
                $('#updDate').val(oData.updDate);
            });
    	}else if (nId != null) {
            var sUrl = _.resolvePath(sContextPath, 'api/device', nId);
            $.get(sUrl).done(function(oData) {
            	$('#tenpoSeqNo').val(oData.tenpoSeqNo);
            	$('#tenpoNo').val(oData.tenpoNo);
                $('#tenpoName').val(oData.tenpoName);
            });
        }
    }

    // 画面初期化
    function onPageLoad() {

        // 画面初期数据取得
        getPageData();

        // 画面初期事件绑定及JS插件渲染
        initializePage();
    }

    // ================================ 方法调用 ================================ //
    // 画面初期化
    onPageLoad();
});
