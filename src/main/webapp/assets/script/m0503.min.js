'use strict';
$(function() {

    // ================================ 变量声明 ================================ //
    // ContextPath
    var sContextPath = _.CONTEXT_PATH;

    var nId = function() {
        if (location.pathname !== _.resolvePath(sContextPath, 'keys')){
            var aslocatoin = location.pathname.split("/");
            // 获取 id
            return aslocatoin[aslocatoin.length - 1];
        }
    }();

    $("#keyName").get(0).focus();
    // ================================ 方法声明 ================================ //
    // JS插件渲染及画面初期事件绑定
    function initializePage() {
        // VALIDATION 验证
        var oValidationOption = _.VALIDATION_OPTIONS;
        oValidationOption.rules = {
        	keyName: {
                required: true,
                chineseAlphabet: true
            },
            timeOut: {
                number: true
            },
        	startTime: {
                required: true,
                hhmmss: true
                
            },
            endTime: {
            	required: true,
            	hhmmss: true
            }       
        };	

        $('#keyForm').validate(oValidationOption);        
        

        $('#moveLeft').click(function() {
        	// 獲取移動源  
            var fromBox = document.getElementById("rightBox");    
            // 獲取移動目的地  
            var toBox = document.getElementById('leftBox');  
            // 當移動源存在選中項時  
            while(fromBox.selectedIndex != -1){  
                // 將移動源中的選中項添加到移動目的地的末尾  
                toBox.appendChild(fromBox.options[fromBox.selectedIndex]);  
            }  
        })
        
     
        $('#moveRight').click(function() {
        	// 獲取移動源  
            var fromBox = document.getElementById('leftBox');    
            // 獲取移動目的地  
            var toBox = document.getElementById('rightBox');  
            // 當移動源存在選中項時  
            while(fromBox.selectedIndex != -1){  
                // 將移動源中的選中項添加到移動目的地的末尾  
                toBox.appendChild(fromBox.options[fromBox.selectedIndex]);  
            }  
        })
        
        $('#moveAllLeft').click(function() {

            var fromBox = document.getElementById('rightBox');    

            var toBox = document.getElementById('leftBox');  
  
            while(fromBox.options.length > 0){  
 
                toBox.appendChild(fromBox.options[0]);  
            }  
        })
        
          
        $('#moveAllRight').click(function() {

            var fromBox = document.getElementById('leftBox');    

            var toBox = document.getElementById('rightBox');  
  
            while(fromBox.options.length > 0){  
 
                toBox.appendChild(fromBox.options[0]);  
            }  
        })
        
        
         $('#moveLeft1').click(function() {
        	// 獲取移動源  
            var fromBox = document.getElementById("rightBox1");    
            // 獲取移動目的地  
            var toBox = document.getElementById('leftBox1');  
            // 當移動源存在選中項時  
            while(fromBox.selectedIndex != -1){  
                // 將移動源中的選中項添加到移動目的地的末尾  
                toBox.appendChild(fromBox.options[fromBox.selectedIndex]);  
            }  
        })
        
     
        $('#moveRight1').click(function() {
        	// 獲取移動源  
            var fromBox = document.getElementById('leftBox1');    
            // 獲取移動目的地  
            var toBox = document.getElementById('rightBox1');  
            // 當移動源存在選中項時  
            while(fromBox.selectedIndex != -1){  
                // 將移動源中的選中項添加到移動目的地的末尾  
                toBox.appendChild(fromBox.options[fromBox.selectedIndex]);  
            }  
        })
        
        $('#moveAllLeft1').click(function() {

            var fromBox = document.getElementById('rightBox1');    

            var toBox = document.getElementById('leftBox1');  
  
            while(fromBox.options.length > 0){  
 
                toBox.appendChild(fromBox.options[0]);  
            }  
        })
        
          
        $('#moveAllRight1').click(function() {

            var fromBox = document.getElementById('leftBox1');    

            var toBox = document.getElementById('rightBox1');  
  
            while(fromBox.options.length > 0){  
 
                toBox.appendChild(fromBox.options[0]);  
            }  
        })
        
        
         $('#moveLeft2').click(function() {
        	// 獲取移動源  
            var fromBox = document.getElementById("rightBox2");    
            // 獲取移動目的地  
            var toBox = document.getElementById('leftBox2');  
            // 當移動源存在選中項時  
            while(fromBox.selectedIndex != -1){  
                // 將移動源中的選中項添加到移動目的地的末尾  
                toBox.appendChild(fromBox.options[fromBox.selectedIndex]);  
            }  
        })
        
     
        $('#moveRight2').click(function() {
        	// 獲取移動源  
            var fromBox = document.getElementById('leftBox2');    
            // 獲取移動目的地  
            var toBox = document.getElementById('rightBox2');  
            // 當移動源存在選中項時  
            while(fromBox.selectedIndex != -1){  
                // 將移動源中的選中項添加到移動目的地的末尾  
                toBox.appendChild(fromBox.options[fromBox.selectedIndex]);  
            }  
        })
        
        $('#moveAllLeft2').click(function() {

            var fromBox = document.getElementById('rightBox2');    

            var toBox = document.getElementById('leftBox2');  
  
            while(fromBox.options.length > 0){  
 
                toBox.appendChild(fromBox.options[0]);  
            }  
        })
        
          
        $('#moveAllRight2').click(function() {

            var fromBox = document.getElementById('leftBox2');    

            var toBox = document.getElementById('rightBox2');  
  
            while(fromBox.options.length > 0){  
 
                toBox.appendChild(fromBox.options[0]);  
            }  
        })
        
        $('#saveBtn').click(function() {
            // 验证失败,则返回
            if (!$('#keyForm').valid()) {
                return false;
            }
            var users = new Array();  //定义数组   
            var approvers = new Array();  //定义数组   
            var administrators = new Array();  //定义数组   
            $("#leftBox option").each(function(){  //遍历所有option  
                 var txt = $(this).val();   //获取option值   
                 if(txt!=''){  
                	 users.push(txt);  //添加到数组中  
                 }  
            })  
            $("#leftBox1 option").each(function(){  //遍历所有option  
                 var txt = $(this).val();   //获取option值   
                 if(txt!=''){  
                	 approvers.push(txt);  //添加到数组中  
                 }  
            })  
            $("#leftBox2 option").each(function(){  //遍历所有option  
                 var txt = $(this).val();   //获取option值   
                 if(txt!=''){  
                	 administrators.push(txt);  //添加到数组中  
                 }  
            })  
            $('#users').val(users);
            $('#approvers').val(approvers);
            $('#administrators').val(administrators);
            // 提交至后台,根据url进行区分
            var sUrl = _.resolvePath(sContextPath, 'api/key', nId);
            $.put(sUrl, $('#keyForm').serializeJSON()).done(function() {
                back();
            });
        })

        
        $('#backBtn').click(function() {
            back();
        });
    }

    //跳回一览画面
    function back(){
    	var backId = $("#kbsSeqNo").val();
        _.route(_.resolvePath(sContextPath, 'device', backId, 'keys'));
    }
    
    
    // 画面初期数据取得
    function getPageData() {
        if (nId != null) {
            var sUrl = _.resolvePath(sContextPath, 'api/key', nId);
            $.get(sUrl).done(function(oData) {
                $('#keyName').val(oData.keyName);
                $('#startTime').val(oData.startTime);
                $('#endTime').val(oData.endTime);
                $('#timeOut').val(oData.timeOut);
                $('#kbsSeqNo').val(oData.kbsSeqNo);
                $('#updDate').val(oData.updDate);
                //可选使用者初始化
                var users = oData.userMap;
                for(var key in users)  {
                	 $('#rightBox').append("<option value='"+ key +"'>"+ users[key] +"</option>");
                }  
                //可选承认者初始化
                var approvers = oData.approveMap;
                for(var key in approvers)  {
                	 $('#rightBox1').append("<option value='"+ key +"'>"+ approvers[key] +"</option>");
                } 
                //可选管理者初始化
                var administrators = oData.administratorMap;
                for(var key in administrators)  {
                	 $('#rightBox2').append("<option value='"+ key +"'>"+ administrators[key] +"</option>");
                } 
                //已选使用者初始化
                var selectUsers = oData.selectUserMap;
                for(var key in selectUsers)  {
                	 $('#leftBox').append("<option value='"+ key +"'>"+ selectUsers[key] +"</option>");
                } 
                //已选承认者初始化
                var selectApprovers = oData.selectApproveMap;
                for(var key in selectApprovers)  {
                	 $('#leftBox1').append("<option value='"+ key +"'>"+ selectApprovers[key] +"</option>");
                } 
                //已选管理者初始化
                var selectAdministrators = oData.selectAdministratorMap;
                for(var key in selectAdministrators)  {
                	 $('#leftBox2').append("<option value='"+ key +"'>"+ selectAdministrators[key] +"</option>");
                } 
            });
            
            
            //钥匙类型
            var sUrlKeytype = _.resolvePath(sContextPath, 'api/key/keytypes');
            $.get(sUrlKeytype).done(function(oData) {
               
                //钥匙类型选择
                var keytypes = oData.keytypeMap;
                for(var keytype in keytypes)  {
                	 $('#keysyuNo').append("<option value='"+ keytype +"'>"+ keytypes[keytype] +"</option>");
                }  
                
            });
            
            
        }
    }

    // 画面初期化
    function onPageLoad() {

        // 画面初期事件绑定及JS插件渲染
        initializePage();

        // 画面初期数据取得
        getPageData();
    }

    // ================================ 方法调用 ================================ //
    // 画面初期化
    onPageLoad();
});
