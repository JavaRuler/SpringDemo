'use strict';
$(function() {

    // ================================ 变量声明 ================================ //
    // ContextPath
    var sContextPath = _.CONTEXT_PATH;
    // 公司信息一览表格
    var oDataTable;
    var nId = function() {
        if (location.pathname !== _.resolvePath(sContextPath, 'users')){
            var aslocatoin = location.pathname.split("/");
            // 获取 id
            return aslocatoin[aslocatoin.length - 2];
        }
    }();

    // ================================ 方法声明 ================================ //
    // JS插件渲染及画面初期事件绑定
    function initializePage() {
    	
    	if (nId != null) {
    		 var oDataTableOption = _.DATATABLES_OPTIONS;
             oDataTableOption.ajax = {
                 url: _.resolvePath(sContextPath, 'api/',nId, 'users'),
                 data: function(oData) {
                     $.extend(oData, $('form').serializeObject());
                 }
             };
             
             oDataTableOption.columns = [ 
                                         {
                                             width: '15%',
                                             data: 'userId'
                                         },
                                         {
                                             width: '15%',
                                             data: 'userName'
                                         },
                                         {
                                             width: '10%',
                                             data: 'groupId'
                                         }
                                        
                                   ]
             
    		 oDataTableOption.columnDefs = [
    				{
    					createdCell : function(dTd, sData) {
    						$(dTd).attr('title', sData);
    					},
    					targets : [ 0, 1 ]
    				},
    				{
    					createdCell : function(dTd, sData) {
    						var userType = '';
    						if(sData == '0'){
    							userType = '机具用户';
    						}
    						if(sData == '1'){
    							userType = '系统用户';
    						}
    						if(sData == '2'){
    							userType = '通用用户';
    						}
    						$(dTd).html(userType);
    					},
    					targets : [ 2 ]
    				},
    				{
    					createdCell : function(dTd, sData, oData) {
    						var uId = oData.userSeqNo;
    						var sBtn = '<a href="javascript:;"'
    								+ 'data-click="edit3" data-click-data="'
    								+ uId
    								+ '" title="编辑"><i class="fa fa-pencil"></i></a>';

    						$(dTd).html(sBtn);
    					},
    					targets : [ 3 ]
    				},
    				{
    					createdCell : function(dTd, sData, oData) {
    						var uId = oData.userSeqNo;
    						var sBtn = '<a href="javascript:;"'
    								+ 'data-click="edit1" data-click-data="'
    								+ uId
    								+ '" title="编辑"><i class="fa fa-pencil"></i></a>';

    						$(dTd).html(sBtn);
    					},
    					targets : [ 4 ]
    				},
    				{
    					createdCell : function(dTd, sData, oData) {
    						var uId = oData.userSeqNo;
    						var sBtn = '<a href="javascript:;"'
    								+ 'data-click="edit2" data-click-data="'
    								+ uId
    								+ '" title="编辑"><i class="fa fa-pencil"></i></a>';

    						$(dTd).html(sBtn);
    					},
    					targets : [ 5 ]
    				},
    				{
    					createdCell : function(dTd, sData, oData) {
    						var uId = oData.userSeqNo;
    						var sBtn = 	'<button type="button" id="57Btn" class="btn btn-success" data-click="send57" data-click-data="'+ uId +'" title="清除机具密码" ><i class="fa fa-send m-r-xs"></i>清除密码</button>';
    						/*sBtn += '<button type="button" id="4EBtn" class="btn btn-success" data-click="send4E" data-click-data="'+ uId +'" title="远程释放请求"><i class="fa fa-send m-r-xs"></i>释放锁定</button>';*/

    						$(dTd).html(sBtn);
    					},
    					targets : [ 6 ]
    				} 
    			]

    		// 获取初始化表格
    		oDataTable = $('#usersTbl').DataTable(oDataTableOption); 
    		
    		// 事件绑定
    		$('#usersTbl').delegate('a[data-click="edit3"]','click',function(){
    			var uId = $(this).data('clickData');
    			// 显示处理成功
    			$("#keyModal").modal();
    			$(":checkbox").prop("checked",false);
    			$('#purview').val('3');
    			$('#kbsSeqNo').val(nId);
                $('#userSeqNo').val(uId);
                $('#userKeyName').html("使用的钥匙选择");
                
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/keys/device', nId);
		            $.get(sUrl).done(function(oData) {
		                $('#kbsNo').val(oData.kbsNo);
		                $('#ipAddressModeal').val(oData.ipAddress);
		            });
		        }
		        //获取钥匙列表
		        if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/', nId, 'keys');
		            $.get(sUrl).done(function(oData) {
		            	$.each(oData,function(i, key){
		                	$('#keyName'+(i+1)).html(key.keyName);
		                	$('#keySeqNo'+(i+1)).val(key.keySeqNo);
		            	});
		            });
		        }
		         //获取有权限的钥匙
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/userKeys/', uId, nId);
		            $.get(sUrl).done(function(oData) {
		            	$.each(oData,function(i, key){
		                	if(key.uset == '0'){
		                		$("#key"+key.holderNo).prop("checked",true);
		                	}
		            	});
		            });
		        }
    		});
    		
    		// 事件绑定
    		$('#usersTbl').delegate('a[data-click="edit1"]','click',function(){
    			var uId = $(this).data('clickData');
    			// 显示处理成功
    			$("#keyModal").modal();
    			$(":checkbox").prop("checked",false);
    			$('#purview').val('1');
    			$('#kbsSeqNo').val(nId);
                $('#userSeqNo').val(uId);
                $('#userKeyName').html("批准者1 的钥匙选择");
                
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/keys/device', nId);
		            $.get(sUrl).done(function(oData) {
		                $('#kbsNo').val(oData.kbsNo);
		                $('#ipAddressModeal').val(oData.ipAddress);
		            });
		        }
		        //获取钥匙列表
		        if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/', nId, 'keys');
		            $.get(sUrl).done(function(oData) {
		            	$.each(oData,function(i, key){
		                	$('#keyName'+(i+1)).html(key.keyName);
		                	$('#keySeqNo'+(i+1)).val(key.keySeqNo);
		            	});
		            });
		        }
		         //获取有权限的钥匙
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/userKeys/', uId, nId);
		            $.get(sUrl).done(function(oData) {
		            	$.each(oData,function(i, key){
		                	if(key.manage == '0'){
		                		$("#key"+key.holderNo).prop("checked",true);
		                	}
		            	});
		            });
		        }
    		});
    		
    		// 事件绑定
    		$('#usersTbl').delegate('a[data-click="edit2"]','click',function(){
    			var uId = $(this).data('clickData');
    			// 显示处理成功
    			$("#keyModal").modal();
    			$(":checkbox").prop("checked",false);
    			$('#purview').val('2');
    			$('#kbsSeqNo').val(nId);
                $('#userSeqNo').val(uId);
                $('#userKeyName').html("批准者2 的钥匙选择");
                
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/keys/device', nId);
		            $.get(sUrl).done(function(oData) {
		                $('#kbsNo').val(oData.kbsNo);
		                $('#ipAddressModeal').val(oData.ipAddress);
		            });
		        }
		        //获取钥匙列表
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/', nId, 'keys');
		            $.get(sUrl).done(function(oData) {
		            	$.each(oData,function(i, key){
		                	$('#keyName'+(i+1)).html(key.keyName);
		                	$('#keySeqNo'+(i+1)).val(key.keySeqNo);
		            	});
		            });
		        }
		        //获取有权限的钥匙
    			if (nId != null) {
		            var sUrl = _.resolvePath(sContextPath, 'api/userKeys/', uId, nId);
		            $.get(sUrl).done(function(oData) {
		            	$.each(oData,function(i, key){
		                	if(key.recognition == '0'){
		                		$("#key"+key.holderNo).prop("checked",true);
		                	}
		            	});
		            });
		        }
		        
    		});
    				
    		
    		// 事件绑定
    		$('#usersTbl').delegate('button[data-click="send57"]','click',function() {
				var uId = $(this).data('clickData');
				// 提交至后台删除数据
				var sUrl = _.resolvePath(sContextPath, 'api/application/userSend57', uId);
	            $.get(sUrl).done(function() {
	            	// 显示处理成功
	    			$.confirm();
	            });
			});
             
        	
    	 }    
        
    	//保存数据
        $('#saveBtn').click(function() {

             // 提交至后台,根据url进行区分
             var sUrl = _.resolvePath(sContextPath, 'api/userkey'); 

             //拼接选择中的key
             var key = "";
             for(var i = 1; i <= 30; i++){
             	if($('#key'+i).is(':checked')){
             		key += 1;
             		if(i != 30){
             			key += ',';
             		}
             	}else{
             		key += 0;
             		if(i != 30){
             			key += ',';
             		}
             	}
             }
             $("#key").val(key);
             
             //拼接key 的Seq
             var keySeqNo = "";
             for(var i = 1; i <= 30; i++){
             	keySeqNo += $("#keySeqNo"+i).val();
             	if(i != 30){
             		keySeqNo += ',';
             	}
             }
             $("#keySeqNo").val(keySeqNo);
             
             $.post(sUrl, $('#keyForm').serializeJSON()).done(function() {
                 saveBack();
             });
         })
        
        $('#backBtn').click(function() {
            back();
        });
        
        
    }

    // 跳回一览画面
    function back(){
        _.route(_.resolvePath(sContextPath, 'userdevices'));      
    }
    
    // 跳回一览画面
    function saveBack(){
        _.route(_.resolvePath(sContextPath, 'device', nId,'users'));
    }

    // 画面初期数据取得
    function getPageData() {
        if (nId != null) {
            var sUrl = _.resolvePath(sContextPath, 'api/keys/device', nId);
            $.get(sUrl).done(function(oData) {
                $('#tenpoName').val(oData.tenpoName);
                $('#ipAddress').val(oData.ipAddress);
                $('#connectPort').val(oData.connectPort);
            });
        }
    }
    
    // 画面初期化
    function onPageLoad() {

        // 画面初期数据取得
        getPageData();
        
        // 画面初期事件绑定及JS插件渲染
        initializePage();
    }

    // ================================ 方法调用 ================================ //
    // 画面初期化
    onPageLoad();
});
