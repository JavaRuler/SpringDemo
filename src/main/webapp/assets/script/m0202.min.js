'use strict';
$(function() {

    // ================================ 变量声明 ================================ //
    // ContextPath
    var sContextPath = _.CONTEXT_PATH;
    // 公司信息一览表格
    var oDataTable;
    var oDataTable1;
    var nId = function() {
        if (location.pathname !== _.resolvePath(sContextPath, 'user')){
            var aslocatoin = location.pathname.split("/");
            // 获取 id
            return aslocatoin[aslocatoin.length - 2];
        }
    }();

    $("#botenTenpoName").get(0).focus();
    // ================================ 方法声明 ================================ //
    // JS插件渲染及画面初期事件绑定
    function initializePage() {
    	
    	if (nId != null) {
    		 var oDataTableOption = _.DATATABLES_OPTIONS;
             oDataTableOption.ajax = {
                 url: _.resolvePath(sContextPath, 'api/organization', nId, 'users'),
                 data: function(oData) {
                     $.extend(oData, $('form').serializeObject());
                 }
             };
             
             oDataTableOption.columns = [ 
                                         {
                                             width: '25%',
                                             data: 'userId'
                                         },
                                         {
                                             width: '25%',
                                             data: 'userName'
                                         },
                                         {
                                             width: '25%',
                                             data: 'groupId'
                                         }
                                         /*,                       
                                         {
                                             width: '25%',
                                             data: 'startDate'
                                         },            
                                         {
                                             width: '25%',
                                             data: 'endDate'
                                         }*/
                                   ]
             
    		 oDataTableOption.columnDefs = [
    				{
    					createdCell : function(dTd, sData) {
    						$(dTd).attr('title', sData);
    					},
    					targets : [ 0, 1 ]
    				},
    				{
    					createdCell : function(dTd, sData) {
    						var userType = '';
    						if(sData == '0'){
    							userType = '机具用户';
    						}
    						if(sData == '1'){
    							userType = '系统用户';
    						}
    						if(sData == '2'){
    							userType = '通用用户';
    						}
    						$(dTd).html(userType);
    					},
    					targets : [ 2 ]
    				},
    				{
    					createdCell : function(dTd, sData, oData) {
    						var nId = oData.userSeqNo;
    						var sBtn = '<a href="javascript:;"'
    								+ 'data-click="edit" data-click-data="'
    								+ nId
    								+ '" title="编辑"><i class="fa fa-pencil"></i></a>';

    						sBtn += '<a href="javascript:;" class="m-l"'
    								+ 'data-click="delete" data-click-data="'
    								+ nId
    								+ '" title="删除"><i class="fa fa-trash"></i></a>';

    						$(dTd).html(sBtn);
    					},
    					targets : [ 3 ]
    				}
    				/*,
    				{
    					createdCell : function(dTd, sData, oData) {
    						var uId = oData.userSeqNo;
    						var sBtn = 	'<button type="button" id="57Btn" class="btn btn-success" data-click="send57" data-click-data="'+ uId +'" title="清除机具密码" ><i class="fa fa-send m-r-xs"></i>清除密码</button>&nbsp;&nbsp;&nbsp;&nbsp';
    						sBtn += '<button type="button" id="4EBtn" class="btn btn-success" data-click="send4E" data-click-data="'+ uId +'" title="远程释放请求"><i class="fa fa-send m-r-xs"></i>释放锁定</button>';

    						$(dTd).html(sBtn);
    					},
    					targets : [ 4 ]
    				} */
    			]

    		// 获取初始化表格
    		oDataTable = $('#usersTbl').DataTable(oDataTableOption);

             
             var oDataTableOption1 = _.DATATABLES_OPTIONS;
             oDataTableOption1.ajax = {
                 url: _.resolvePath(sContextPath, 'api/organizations/branch', nId),
                 data: function(oData) {
                     $.extend(oData, $('form').serializeObject());
                 }
             };
             
             oDataTableOption1.columns = [ 
                                         {
                                             width: '30%',
                                             data: 'tenpoNo'
                                         },
                                         {
                                             width: '30%',
                                             data: 'tenpoName'
                                         }
                                         /*,            
                                         {
                                             width: '28%',
                                             data: 'ipSeg'
                                         }
                                         ,            
                                         {
                                             width: '15%',
                                             data: 'startDate'
                                         }
                                         ,            
                                         {
                                             width: '15%',
                                             data: 'endDate'
                                         }*/
                                   ]
             
             oDataTableOption1.columnDefs = [
    				{
    					createdCell : function(dTd, sData) {
    						$(dTd).attr('title', sData);
    					},
    					targets : [ 0, 1]
    				},
    				{
    					createdCell : function(dTd, sData, oData) {
    						var nId = oData.tenpoSeqNo;
    						var sBtn = '<a href="javascript:;"'
    								+ 'data-click="next" data-click-data="'
    								+ nId
    								+ '" title="进入"><i class="fa fa-arrow-right"></i></a>';


    						$(dTd).html(sBtn);
    					},
    					targets : [ 2 ]
    				} ]

    		// 获取初始化表格		
            oDataTable1 = $('#orgnaizationTbl').DataTable(oDataTableOption1);
             
             
    		// 事件绑定
    		$('#usersTbl').delegate(
    				'a[data-click="delete"]',
    				'click',
    				function() {
    					var nId = $(this).data('clickData');
    					$.alert(function(bConfirm) {
    						if (bConfirm) {
    							// 提交至后台删除数据
    							var sUrl = _.resolvePath(sContextPath,
    									'api/user', nId);
    							$.del(sUrl).done(function() {
    								// 显示处理成功
    								$.confirm();
    								// 重新加载时不重置用户分页
    								oDataTable.ajax.reload(null, false);
    							});
    						}
    					});
    				});
    				
    		// 事件绑定
    		$('#usersTbl').delegate('button[data-click="send57"]','click',function() {
				var uId = $(this).data('clickData');
				// 提交至后台删除数据
				var sUrl = _.resolvePath(sContextPath, 'api/application/userSend57', uId);
	            $.get(sUrl).done(function() {
	            	// 显示处理成功
	    			$.confirm();
	            });
			});
			
    		// 事件绑定
    		$('#usersTbl').delegate('button[data-click="send4E"]','click',function() {
				var uId = $(this).data('clickData');
				// 提交至后台删除数据
				var sUrl = _.resolvePath(sContextPath, 'api/application/userSend4E', uId);
	            $.get(sUrl).done(function() {
	            	// 显示处理成功
	    			$.confirm();
	            });
			});

    		$('#usersTbl').delegate('a[data-click="edit"]', 'click',
    				function() {
    					var nUserId = $(this).data('clickData');
    					_.route(_.resolvePath(sContextPath, 'orgnaization', nId, 'user', nUserId));
    				});
    		$('#orgnaizationTbl').delegate('a[data-click="next"]', 'click',
    				function() {
    					var nUserId = $(this).data('clickData');
    					_.route(_.resolvePath(sContextPath, 'orgnaization', nUserId, 'users'));
    				});
        	
    	}
        
         $('#createBtn').click(function() {
        	 _.route(_.resolvePath(sContextPath, 'orgnaization', nId, 'user'));
        })

        
        
        $('#backBtn').click(function() {
            back();
        });
        
        
        $('#searchBtn').click(function() {
            oDataTable.ajax.reload();
            oDataTable1.ajax.reload();
        });
    }
    
    
    
    // 跳回一览画面
    function back(){
    	 var botenSeqNo = $('#botenSeqNo').val();
         if (botenSeqNo != 0) {
        	 _.route(_.resolvePath(sContextPath, 'orgnaization',botenSeqNo,'users'));
         } else {
        	 _.route(_.resolvePath(sContextPath, 'user/orgnaizations'));
         }
       
    }

    // 画面初期数据取得
    function getPageData() {
        if (nId != null) {
            var sUrl = _.resolvePath(sContextPath, 'api/orgnaization', nId);
            $.get(sUrl).done(function(oData) {
                $('#tenpoNo').val(oData.tenpoNo);
                $('#tenpoName').val(oData.tenpoName);
                $('#botenSeqNo').val(oData.botenSeqNo);
            });
        }
    }

    // 画面初期化
    function onPageLoad() {

        // 画面初期事件绑定及JS插件渲染
        initializePage();

        // 画面初期数据取得
        getPageData();
    }

    // ================================ 方法调用 ================================ //
    // 画面初期化
    onPageLoad();
});
